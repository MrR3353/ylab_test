# Тестовое задание для YLab_University.
### Часть 1.
Написать проект на FastAPI с использованием PostgreSQL в качестве БД. В проекте следует реализовать REST API по работе с меню ресторана, все CRUD операции. Для проверки задания, к презентаций будет приложена Postman коллекция с тестами. Задание выполнено, если все тесты проходят успешно.
Даны 3 сущности: Меню, Подменю, Блюдо.

Зависимости:
●У меню есть подменю, которые к ней привязаны.
●У подменю есть блюда.

Условия:
●Блюдо не может быть привязано напрямую к меню, минуя подменю.
●Блюдо не может находиться в 2-х подменю одновременно.
●Подменю не может находиться в 2-х меню одновременно.
●Если удалить меню, должны удалиться все подменю и блюда этого меню.
●Если удалить подменю, должны удалиться все блюда этого подменю.
●Цены блюд выводить с округлением до 2 знаков после запятой.
●Во время выдачи списка меню, для каждого меню добавлять кол-во подменю и блюд в этом меню.
●Во время выдачи списка подменю, для каждого подменю добавлять кол-во блюд в этом подменю.
●Во время запуска тестового сценария БД должна быть пуста.

### Часть 2.
Обернуть программные компоненты в контейнеры. Контейнеры должны запускаться по одной команде “docker-compose up -d” или той которая описана вами в readme.md.

1.Написать CRUD тесты для ранее разработанного API с помощью библиотеки pytest
2.Подготовить отдельный контейнер для запуска тестов. Команду для запуска указать в README.md
3.* Реализовать вывод количества подменю и блюд для Меню через один (сложный) ORM запрос.
4.** Реализовать тестовый сценарий «Проверка кол-ва блюд и подменю в меню» из Postman с помощью pytest
Если FastAPI синхронное - тесты синхронные, Если асинхронное - тесты асинхронные

### Часть 3.
1.Вынести бизнес логику и запросы в БД в отдельные слои приложения.
2.Добавить кэширование запросов к API  с использованием Redis. Не забыть про инвалидацию кэша.
3.Добавить pre-commit хуки в проект. Файл yaml будет прикреплен к ДЗ.
4.Покрыть проект type hints (тайпхинтами)
5.* Описать ручки API в соответствий c OpenAPI
6.** Реализовать в тестах аналог Django reverse() для FastAPI

﻿﻿﻿﻿﻿﻿Требования:
●Код должен проходить все линтеры.
●Код должен соответствовать принципам SOLID, DRY, KISS.
●Проект должен запускаться по одной команде (докер).
●Проект должен проходить все Postman тесты (коллекция с Вебинара №1).
●Тесты написанные вами после Вебинара №2, должны быть актуальны, запускать и успешно проходить

### Часть 4.

В этом домашнем задании необходимо:
1.Переписать текущее FastAPI приложение на асинхронное выполнение
2.Добавить в проект фоновую задачу с помощью Celery + RabbitMQ.
3.Добавить эндпоинт (GET) для вывода всех меню со всеми связанными подменю и со всеми связанными блюдами.
4.Реализовать инвалидация кэша в background task (встроено в FastAPI)
5.* Обновление меню из google sheets раз в 15 сек.
6.** Блюда по акции. Размер скидки (%) указывается в столбце G файла Menu.xlsx

Фоновая задача: синхронизация Excel документа и БД.
   В проекте создаем папку admin. В эту папку кладем файл Menu.xlsx (будет прикреплен к ДЗ). Не забываем запушить в гит.
   При внесении изменений в файл все изменения должны отображаться в БД. Периодичность обновления 15 сек. Удалять БД при каждом обновлении – нельзя. 

Требования:
●Данные меню, подменю, блюд для нового эндпоинта должны доставаться одним ORM-запросом в БД (использовать подзапросы и агрегирующие функций SQL).
●Проект должен запускаться одной командой
●Проект должен соответствовать требованиям всех предыдущих вебинаров. (Не забыть добавить тесты для нового API эндпоинта)


### Стек:
* Fastapi
* asyncpg
* PostgreSQL
* Docker Compose
* Redis
* Celery + RabbitMQ

### **Запуск проекта:**

Приложение, БД, Celery, Redis:
`docker compose up --build`

Тесты и Postman (запускать после приложения, без Celery или не во время выполнения задач на Celery):
`docker compose -f docker-compose-test.yml up --build`

Включить/отключить кеширование можно в src/config.py CACHE_ENABLE = False
Включить/отключить Celery можно в src/config.py CELERY_ON = False

Выполнено задание: ** Блюда по акции.
Скидки можно применять только к блюдам. Функция cache_discounts() в файле update_admin отвечает за кэширование скидок на блюда в редис, инвалидацию кэша старых скидок, и инвалидацию кэша приложения для блюд и списка блюд.
После сохранения в кэш, этот кэш используется методом apply_discount() в services.dish, чтобы применить скидку к блюду/списку блюд. Этот метод используется геттерами в services.dish и методом get_all_with_submenu_dishes() в services.menu
